{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}ä¸€èˆ¬ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä¸€è¦§{% endblock %}

{% block content %}
<ul>
    {% for profile in profiles %}
        <li>
            <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã®è¡¨ç¤º -->
            {% if profile.profile_image %}
                <img src="{{ profile.profile_image.url }}" alt="Profile Image" width="100">
            {% elif profile.user.profile_image and profile.user.profile_image.name != "profile_images/default_profile_image.jpg" %}
                <img src="{{ profile.user.profile_image.url }}" alt="Profile Image" width="100">
            {% else %}
                <img src="/media/profile_images/default_profile_image.png" alt="Profile Image" width="100">
            {% endif %}
            
            <strong>
                <a href="{% url 'users:general_account_detail' user_id=profile.user.id %}">
                    {{ profile.name|default:profile.user.name|default:"æœªè¨­å®š" }}
                </a>
            </strong> - {{ profile.get_gender_display|default:"æœªè¨­å®š"}}
            
            <!-- ã„ã„ã­ãƒœã‚¿ãƒ³ -->
            <button class="like-btn" data-profile-id="{{ profile.id }}">
                ğŸ‘ {{ profile.likes_count }}
            </button>
        </li>
    {% empty %}
        <li>No profiles available.</li>
    {% endfor %}
</ul>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const likeButtons = document.querySelectorAll('.like-btn');
    const csrfToken = "{{ csrf_token|safe }}";  // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…ã§CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—

    likeButtons.forEach(button => {
        button.addEventListener('click', async () => {
            const profileId = button.dataset.profileId;
            if (!profileId) {
                console.error("Profile ID not found!");
                return;
            }

            // ãƒªã‚¯ã‚¨ã‚¹ãƒˆå…ˆURL
            const likeToggleUrl = `/accounts/like_toggle/${profileId}/`;

            try {
                const response = await fetch(likeToggleUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                    body: JSON.stringify({}), // ä»Šå›ã¯ç‰¹ã«é€ã‚‹ãƒ‡ãƒ¼ã‚¿ãªã—
                });

                // --- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯ ---
                if (!response.ok) {
                    // 403ã®å ´åˆ â†’ JSONã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ã€redirectãŒã‚ã‚Œã°ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                    if (response.status === 403) {
                        const data = await response.json();
                        if (data.redirect) {
                            window.location.href = data.redirect;
                            return;
                        }
                    }
                    throw new Error('Network response was not ok');
                }

                // --- æˆåŠŸæ™‚ï¼ˆ200 OKï¼‰ ---
                const data = await response.json();
                if (data.success) {
                    // ã€Œã„ã„ã­æ•°ã€ã‚’æ›´æ–°
                    button.textContent = `ğŸ‘ ${data.likes}`;
                } else {
                    alert('Failed to like the profile.'); // data.message ã‚’å‡ºã—ã¦ã‚‚OK
                }
            } catch (error) {
                console.error('Error:', error);
            }
        });
    });
});
</script>
{% endblock %}



