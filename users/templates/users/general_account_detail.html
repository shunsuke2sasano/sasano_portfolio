{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}{{ profile.name|default:profile.user.name }} ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«{% endblock %}

{% block content %}
    <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã®è¡¨ç¤º -->
    {% if profile.profile_image %}
        <img src="{{ profile.profile_image.url }}" alt="Profile Image" width="100">
    {% elif profile.user.profile_image and profile.user.profile_image.name != "profile_images/default_profile_image.jpg" %}
        <img src="{{ profile.user.profile_image.url }}" alt="Profile Image" width="100">
    {% else %}
        <img src="/media/profile_images/default_profile_image.png" alt="Profile Image" width="100">
    {% endif %}

    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®è¡¨ç¤º -->
    <p>åå‰: {{ profile.name|default:profile.user.name|default:"æœªè¨­å®š" }}</p>
    <p>ãµã‚ŠãŒãª: {{ profile.furigana|default:"æœªè¨­å®š" }}</p>
    <p>æ€§åˆ¥: {{ profile.get_gender_display|default:"æœªè¨­å®š" }}</p>
    <p>å¹´é½¢: {{ profile.age|default:"æœªè¨­å®š" }}</p>
    <p>è‡ªå·±ç´¹ä»‹: {{ profile.bio|default:"æœªè¨­å®š" }}</p>
    <p>ã„ã„ã­æ•°: {{ profile.likes_count }}</p>

    <!-- ã„ã„ã­ãƒœã‚¿ãƒ³ -->
    <button class="like-btn" data-profile-id="{{ profile.id }}">
        ğŸ‘ {{ profile.likes_count }}
    </button>

    <!-- ã“ã“ã§CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’JSã§ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ -->
    <script>
        const csrfToken = "{{ csrf_token|safe }}";

        function getLikeToggleUrl(profileId) {
            return `/accounts/like_toggle/${profileId}/`;
        }
    </script>

    <script src="{% static 'accounts/like_toggle.js' %}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const likeButtons = document.querySelectorAll('.like-btn');
        const csrfToken = "{{ csrf_token|safe }}";  // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…ã§CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
    
        likeButtons.forEach(button => {
            button.addEventListener('click', async () => {
                const profileId = button.dataset.profileId;
                if (!profileId) {
                    console.error("Profile ID not found!");
                    return;
                }
    
                // ãƒªã‚¯ã‚¨ã‚¹ãƒˆå…ˆURL
                const likeToggleUrl = `/accounts/like_toggle/${profileId}/`;
    
                try {
                    const response = await fetch(likeToggleUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken,
                        },
                        body: JSON.stringify({}), // ä»Šå›ã¯ç‰¹ã«é€ã‚‹ãƒ‡ãƒ¼ã‚¿ãªã—
                    });
    
                    // --- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯ ---
                    if (!response.ok) {
                        // 403ã®å ´åˆ â†’ JSONã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ã€redirectãŒã‚ã‚Œã°ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                        if (response.status === 403) {
                            const data = await response.json();
                            if (data.redirect) {
                                window.location.href = data.redirect;
                                return;
                            }
                        }
                        throw new Error('Network response was not ok');
                    }
    
                    // --- æˆåŠŸæ™‚ï¼ˆ200 OKï¼‰ ---
                    const data = await response.json();
                    if (data.success) {
                        // ã€Œã„ã„ã­æ•°ã€ã‚’æ›´æ–°
                        button.textContent = `ğŸ‘ ${data.likes}`;
                    } else {
                        alert('Failed to like the profile.'); // data.message ã‚’å‡ºã—ã¦ã‚‚OK
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            });
        });
    });
    </script>
    {% endblock %}
